<!DOCTYPE html>
<html class="dark" lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>지출 통계 리포트</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec5b",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "3xl": "1.5rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        @keyframes dash {
            from {
                stroke-dashoffset: 100;
            }

            to {
                stroke-dashoffset: 0;
            }
        }

        .chart-circle {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 antialiased selection:bg-primary selection:text-black">
    <div
        class="relative flex h-full min-h-screen w-full max-w-md mx-auto flex-col overflow-hidden bg-background-light dark:bg-background-dark shadow-2xl">
        <header class="flex items-center justify-between px-4 pt-6 pb-2">
            <button onclick="window.history.back()"
                class="flex h-10 w-10 items-center justify-center rounded-full text-slate-900 hover:bg-slate-200 dark:text-white dark:hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h1 class="text-lg font-bold tracking-tight">통계</h1>
            <div class="h-10 w-10"></div>
        </header>
        <main class="flex-1 overflow-y-auto px-4 pb-24">
            <div class="mt-4 mb-6 flex items-center justify-center gap-4">
                <button id="prevBtn"
                    class="flex h-8 w-8 items-center justify-center rounded-full bg-slate-200 text-slate-600 hover:bg-slate-300 dark:bg-white/5 dark:text-slate-400 dark:hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined text-sm">arrow_back_ios_new</span>
                </button>
                <div class="flex flex-col items-center">
                    <span id="yearDisplay"
                        class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider"></span>
                    <span id="monthDisplay" class="text-xl font-bold text-slate-900 dark:text-white"></span>
                </div>
                <button id="nextBtn"
                    class="flex h-8 w-8 items-center justify-center rounded-full bg-slate-200 text-slate-600 hover:bg-slate-300 dark:bg-white/5 dark:text-slate-400 dark:hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined text-sm">arrow_forward_ios</span>
                </button>
            </div>
            <div class="mb-8 flex justify-center">
                <div class="flex rounded-full bg-slate-200 p-1 dark:bg-white/5">
                    <button
                        class="rounded-full bg-white px-6 py-2 text-sm font-bold text-black shadow-sm dark:bg-primary transition-all">
                        지출 (카테고리)
                    </button>
                    <button
                        class="rounded-full px-6 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors cursor-not-allowed opacity-50">
                        결제자 비율
                    </button>
                </div>
            </div>
            <div class="relative mb-8 flex flex-col items-center justify-center">
                <div class="relative h-64 w-64">
                    <svg id="donut" class="h-full w-full chart-circle" viewBox="0 0 36 36">
                        <!-- SVG injected by JS -->
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-sm font-medium text-slate-500 dark:text-slate-400">총 지출</span>
                        <span id="sumDisplay"
                            class="text-2xl font-bold tracking-tight text-slate-900 dark:text-white"></span>
                    </div>
                </div>
            </div>
            <div class="flex flex-col gap-4">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-base font-bold text-slate-900 dark:text-white">카테고리별 지출</h2>
                    <span class="text-xs font-medium text-primary">순위별 정렬</span>
                </div>

                <div id="catList" class="space-y-3">
                    <!-- Category spending rows injected by JS -->
                </div>

            </div>
            <div class="mt-6 rounded-xl bg-gradient-to-r from-emerald-900 to-green-900 p-6 relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-1/2 opacity-20"
                    style="background: radial-gradient(circle at center, #13ec5b 0%, transparent 70%);"></div>
                <div class="relative z-10">
                    <div class="mb-2 flex h-8 w-8 items-center justify-center rounded-full bg-primary/20 text-primary">
                        <span class="material-symbols-outlined text-sm">lightbulb</span>
                    </div>
                    <h3 class="mb-1 text-lg font-bold text-white">커플 소비 인사이트</h3>
                    <p id="insightText" class="text-sm text-slate-300">데이터를 분석 중입니다...</p>
                </div>
            </div>
        </main>
        <nav
            class="absolute bottom-0 w-full border-t border-slate-200 bg-white/90 px-6 pb-6 pt-3 backdrop-blur-md dark:border-white/5 dark:bg-[#15231b]/90">
            <div class="flex justify-between">
                <a class="group flex flex-1 flex-col items-center gap-1" href="/">
                    <span
                        class="material-symbols-outlined text-slate-400 transition-colors group-hover:text-primary dark:text-slate-500 dark:group-hover:text-primary">home</span>
                    <span
                        class="text-[10px] font-medium text-slate-400 transition-colors group-hover:text-primary dark:text-slate-500 dark:group-hover:text-primary">홈</span>
                </a>
                <a class="group flex flex-1 flex-col items-center gap-1" href="#">
                    <span class="material-symbols-outlined fill-current text-primary">donut_small</span>
                    <span class="text-[10px] font-medium text-primary">통계</span>
                </a>
                <div class="relative -top-8 flex flex-1 justify-center">
                    <button onclick="window.location.href='/'"
                        class="flex h-14 w-14 items-center justify-center rounded-full bg-primary text-black shadow-lg shadow-primary/40 transition-transform hover:scale-105 active:scale-95">
                        <span class="material-symbols-outlined text-3xl">photo_camera</span>
                    </button>
                </div>
                <a class="group flex flex-1 flex-col items-center gap-1" href="/calendar">
                    <span
                        class="material-symbols-outlined text-slate-400 transition-colors group-hover:text-primary dark:text-slate-500 dark:group-hover:text-primary">calendar_month</span>
                    <span
                        class="text-[10px] font-medium text-slate-400 transition-colors group-hover:text-primary dark:text-slate-500 dark:group-hover:text-primary">달력</span>
                </a>
                <a class="group flex flex-1 flex-col items-center gap-1" href="/settings">
                    <span
                        class="material-symbols-outlined text-slate-400 transition-colors group-hover:text-primary dark:text-slate-500 dark:group-hover:text-primary">person</span>
                    <span
                        class="text-[10px] font-medium text-slate-400 transition-colors group-hover:text-primary dark:text-slate-500 dark:group-hover:text-primary">설정</span>
                </a>
            </div>
        </nav>
    </div>

    <script type="module">
        import { getTx, ym, won, getCatIconInfo } from './app.js';

        const colors = [
            { name: 'green', code: '#13ec5b', fill: 'bg-[#13ec5b]/20 text-[#13ec5b]' },
            { name: 'teal', code: '#2dd4bf', fill: 'bg-[#2dd4bf]/20 text-[#2dd4bf]' },
            { name: 'blue', code: '#60a5fa', fill: 'bg-[#60a5fa]/20 text-[#60a5fa]' },
            { name: 'purple', code: '#c084fc', fill: 'bg-[#c084fc]/20 text-[#c084fc]' },
            { name: 'pink', code: '#f472b6', fill: 'bg-[#f472b6]/20 text-[#f472b6]' },
            { name: 'orange', code: '#fb923c', fill: 'bg-[#fb923c]/20 text-[#fb923c]' },
            { name: 'yellow', code: '#facc15', fill: 'bg-[#facc15]/20 text-[#facc15]' },
        ];

        let cur = new Date();

        function render() {
            const month = ym(cur);
            document.getElementById('yearDisplay').textContent = `${cur.getFullYear()}년`;
            document.getElementById('monthDisplay').textContent = `${cur.getMonth() + 1}월`;

            const tx = getTx().filter(t => t.tx_date?.startsWith(month));

            let total = 0;
            let meAmt = 0;
            let youAmt = 0;
            let togetherAmt = 0;

            // category aggregation
            const catMap = {};

            tx.forEach(t => {
                const amt = Number(t.amount || 0);
                total += amt;

                if (t.payer === 'me') meAmt += amt;
                else if (t.payer === 'you') youAmt += amt;
                else if (t.payer === 'together') togetherAmt += amt;

                const cat = t.category || '기타';
                catMap[cat] = (catMap[cat] || 0) + amt;
            });

            document.getElementById('sumDisplay').textContent = won(total);

            const rows = Object.entries(catMap).sort((a, b) => b[1] - a[1]);

            // Insights
            let insightStr = "이번 달은 지출이 없습니다.";
            if (total > 0) {
                let maxSub = "알 수 없음";
                let maxVal = 0;
                if (meAmt > maxVal) { maxVal = meAmt; maxSub = "본인"; }
                if (youAmt > maxVal) { maxVal = youAmt; maxSub = "상대방"; }
                if (togetherAmt > maxVal) { maxVal = togetherAmt; maxSub = "공동(함께)"; }

                const mostCat = rows[0][0];
                insightStr = `이번 달은 ${mostCat} 항목의 지출이 가장 컸습니다. 전체 결제 중 <span class="text-primary font-bold">${maxSub}</span> 결제 비중이 제일 높네요!`;
            }
            document.getElementById('insightText').innerHTML = insightStr;

            // Build SVG Doughnut + Category list DOM
            const donutSvg = document.getElementById('donut');
            let svgHtml = `<path class="text-slate-200 dark:text-white/5" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3"></path>`;

            const listEl = document.getElementById('catList');
            listEl.innerHTML = '';

            if (rows.length === 0) {
                listEl.innerHTML = '<div class="text-center text-slate-400 py-4">데이터 없음</div>';
            } else {
                let currentOffset = 0; // percentage

                rows.forEach(([catTitle, val], index) => {
                    const percNumber = total > 0 ? (val / total) * 100 : 0;
                    const percString = Math.round(percNumber) + '%';

                    // Map colors safely
                    const colorObj = colors[index % colors.length];

                    // stroke-dasharray format: array, gap => e.g., "25, 100"
                    // stroke-dashoffset: - (sum of previous percentages)
                    // Note: circumference is 100 in this simplified viewBox=36 36 path

                    // Avoid drawing if 0%
                    if (percNumber > 0) {
                        const dashArray = `${percNumber}, 100`;
                        const offset = -currentOffset;

                        svgHtml += `<path stroke="${colorObj.code}" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-dasharray="${dashArray}" stroke-dashoffset="${offset}" stroke-linecap="round" stroke-width="3" style="transition: stroke-dasharray 1s ease-out;"></path>`;

                        currentOffset += percNumber;
                    }

                    // List rendering
                    const cIcon = getCatIconInfo(catTitle);

                    listEl.innerHTML += `
            <div class="group flex items-center justify-between rounded-xl bg-white p-4 shadow-sm transition-all hover:bg-slate-50 dark:bg-white/5 dark:hover:bg-white/10">
                <div class="flex items-center gap-4">
                    <div class="flex h-12 w-12 items-center justify-center rounded-full ${colorObj.fill}">
                        <span class="material-symbols-outlined">${cIcon.icon}</span>
                    </div>
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-slate-900 dark:text-white">${catTitle}</span>
                            <span class="rounded bg-slate-100 px-1.5 py-0.5 text-[10px] font-bold text-slate-500 dark:bg-white/10 dark:text-slate-400">${percString}</span>
                        </div>
                        <span class="text-xs text-slate-500 dark:text-slate-400">총 ${tx.filter(t => t.category === catTitle).length}건</span>
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <span class="font-bold text-slate-900 dark:text-white">${won(val)}</span>
                </div>
            </div>`;
                });
            }

            donutSvg.innerHTML = svgHtml;
        }

        document.getElementById('prevBtn').onclick = () => { cur.setMonth(cur.getMonth() - 1); render(); };
        document.getElementById('nextBtn').onclick = () => { cur.setMonth(cur.getMonth() + 1); render(); };

        render();
    </script>
</body>

</html>